    /**
     * Test searching media file.
     */
    public void testSearchMediaFile() throws Exception {

        User testUser = null;
        Weblog testWeblog = null;
        testUser = TestUtils.setupUser("mediaFileTestUser7");
        testWeblog = TestUtils.setupWeblog("mediaFileTestWeblog7", testUser);

        MediaFileManager mfMgr = WebloggerFactory.getWeblogger().getMediaFileManager();

        // no need to create root directory, that is done automatically now
        MediaFileDirectory rootDirectory = mfMgr.getMediaFileRootDirectory(testWeblog);

        //MediaFileDirectory rootDirectory = new MediaFileDirectory(null, "root", "root d", testWeblog);
        //mfMgr.createMediaFileDirectory(rootDirectory);

        TestUtils.endSession(true);

        testWeblog = TestUtils.getManagedWebsite(testWeblog);
        rootDirectory = mfMgr.getMediaFileDirectory(rootDirectory.getId());

        MediaFile mediaFile = new MediaFile();
        mediaFile.setName("test_work.jpg");
        mediaFile.setDescription("This is a test image");
        mediaFile.setCopyrightText("test copyright text");
        mediaFile.setSharedForGallery(true);
        mediaFile.setLength(2000);
        mediaFile.setDirectory(rootDirectory);
        mediaFile.setWeblog(testWeblog);
        mediaFile.setInputStream(getClass().getResourceAsStream(TEST_IMAGE));
        mediaFile.setContentType("image/jpeg");

        MediaFileTag tag1 = new MediaFileTag("work", mediaFile);
        Set<MediaFileTag> tags = new HashSet<MediaFileTag>();
        tags.add(tag1);
        mediaFile.setTags(tags);

        mfMgr.createMediaFile(testWeblog, mediaFile);
        TestUtils.endSession(true);
        assertNotNull(mediaFile.getId());
        assertNotNull(mediaFile.getId().length() > 0);

        testWeblog = TestUtils.getManagedWebsite(testWeblog);
        MediaFile mediaFile1 = new MediaFile();
        mediaFile1 = new MediaFile();
        mediaFile1.setName("test_home.jpg");
        mediaFile1.setDescription("This is a test image");
        mediaFile1.setCopyrightText("test copyright text");
        mediaFile1.setSharedForGallery(true);
        mediaFile1.setLength(3000);
        mediaFile1.setDirectory(rootDirectory);
        mediaFile1.setWeblog(testWeblog);
        mediaFile1.setInputStream(getClass().getResourceAsStream(TEST_IMAGE));
        mediaFile1.setContentType("image/jpeg");

        MediaFileTag tag2 = new MediaFileTag("home", mediaFile1);
        tags = new HashSet<MediaFileTag>();
        tags.add(tag2);
        mediaFile1.setTags(tags);

        mfMgr.createMediaFile(testWeblog, mediaFile1);
        TestUtils.endSession(true);
        assertNotNull(mediaFile1.getId());
        assertNotNull(mediaFile1.getId().length() > 0);

        testWeblog = TestUtils.getManagedWebsite(testWeblog);
        MediaFile mediaFile2 = new MediaFile();
        mediaFile2 = new MediaFile();
        mediaFile2.setName("test_pers.jpg");
        mediaFile2.setDescription("This is a personal test image");
        mediaFile2.setCopyrightText("test pers copyright text");
        mediaFile2.setSharedForGallery(true);
        mediaFile2.setLength(4000);
        mediaFile2.setWeblog(testWeblog);
        mediaFile2.setDirectory(rootDirectory);
        mediaFile2.setInputStream(getClass().getResourceAsStream(TEST_IMAGE));
        mediaFile2.setContentType("image/jpeg");

        MediaFileTag tag3 = new MediaFileTag("home", mediaFile2);
        tags = new HashSet<MediaFileTag>();
        tags.add(tag3);
        mediaFile2.setTags(tags);

        mfMgr.createMediaFile(testWeblog, mediaFile2);
        TestUtils.endSession(true);
        assertNotNull(mediaFile2.getId());
        assertNotNull(mediaFile2.getId().length() > 0);

        testWeblog = TestUtils.getManagedWebsite(testWeblog);

        List<MediaFile> searchResults;

        MediaFileFilter filter1 = new MediaFileFilter();
        filter1.setName("mytest.jpg");
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter1);
        assertTrue(searchResults.isEmpty());

        MediaFileFilter filter2 = new MediaFileFilter();
        filter2.setName("test_home.jpg");
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter2);
        assertFalse(searchResults.isEmpty());
        assertEquals(mediaFile1.getId(), ((MediaFile) searchResults.get(0)).getId());
        assertNotNull(((MediaFile) searchResults.get(0)).getDirectory());
        assertEquals("/", ((MediaFile) searchResults.get(0)).getDirectory().getPath());

        MediaFileFilter filter3 = new MediaFileFilter();
        filter3.setName("test_work.jpg");
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter3);
        assertFalse(searchResults.isEmpty());
        assertEquals(mediaFile.getId(), ((MediaFile) searchResults.get(0)).getId());

        MediaFileFilter filter4 = new MediaFileFilter();
        filter4.setTags(Arrays.asList("work"));
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter4);
        assertFalse(searchResults.isEmpty());
        assertEquals(1, searchResults.size());
        assertEquals("test_work.jpg", ((MediaFile) searchResults.get(0)).getName());

        MediaFileFilter filter5 = new MediaFileFilter();
        filter5.setTags(Arrays.asList("home"));
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter5);
        assertFalse(searchResults.isEmpty());
        assertEquals(2, searchResults.size());

        MediaFileFilter filter6 = new MediaFileFilter();
        filter6.setSize(3000);
        filter6.setSizeFilterType(MediaFileFilter.SizeFilterType.LT);
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter6);
        assertFalse(searchResults.isEmpty());
        assertEquals(1, searchResults.size());
        assertEquals("test_work.jpg", ((MediaFile) searchResults.get(0)).getName());

        MediaFileFilter filter7 = new MediaFileFilter();
        filter7.setSize(3000);
        filter7.setSizeFilterType(MediaFileFilter.SizeFilterType.EQ);
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter7);
        assertFalse(searchResults.isEmpty());
        assertEquals(1, searchResults.size());
        assertEquals("test_home.jpg", ((MediaFile) searchResults.get(0)).getName());

        MediaFileFilter filter8 = new MediaFileFilter();
        filter8.setSize(3000);
        filter8.setSizeFilterType(MediaFileFilter.SizeFilterType.GT);
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter8);
        assertFalse(searchResults.isEmpty());
        assertEquals(1, searchResults.size());
        assertEquals("test_pers.jpg", ((MediaFile) searchResults.get(0)).getName());

        MediaFileFilter filter9 = new MediaFileFilter();
        filter9.setSize(3000);
        filter9.setSizeFilterType(MediaFileFilter.SizeFilterType.LTE);
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter9);
        assertFalse(searchResults.isEmpty());
        assertEquals(2, searchResults.size());

        MediaFileFilter filter10 = new MediaFileFilter();
        filter10.setSize(3000);
        filter10.setSizeFilterType(MediaFileFilter.SizeFilterType.GTE);
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter10);
        assertFalse(searchResults.isEmpty());
        assertEquals(2, searchResults.size());

        MediaFileFilter filter11 = new MediaFileFilter();
        filter11.setType(MediaFileType.IMAGE);
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter11);
        assertFalse(searchResults.isEmpty());
        assertEquals(3, searchResults.size());

        MediaFileFilter filter12 = new MediaFileFilter();
        filter12.setType(MediaFileType.IMAGE);
        filter12.setTags(Arrays.asList("home"));
        searchResults = mfMgr.searchMediaFiles(testWeblog, filter12);
        assertFalse(searchResults.isEmpty());
        assertEquals(2, searchResults.size());

        TestUtils.endSession(true);
        TestUtils.teardownWeblog(testWeblog.getId());
        TestUtils.teardownUser(testUser.getUserName());
    }


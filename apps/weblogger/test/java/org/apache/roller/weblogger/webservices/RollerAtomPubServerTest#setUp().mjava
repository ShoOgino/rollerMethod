    /**
     * Set up Servlet mocks and test data
     */
    public void setUp() throws Exception {

        try {
            TestUtils.setupWeblogger();

            mockFactory = new WebMockObjectFactory();

            // create mock RollerContext
            MockServletContext ctx = mockFactory.getMockServletContext();

            ctx.setRealPath("/", ".");
            ctx.setInitParameter(
                "contextConfigLocation", "/WEB-INF/security.xml");

            ctx.setResourceAsStream("/WEB-INF/security.xml",
                this.getClass().getResourceAsStream("/WEB-INF/security.xml"));
            ctx.setResourceAsStream("/WEB-INF/velocity.properties",
                this.getClass().getResourceAsStream("/WEB-INF/velocity.properties"));

            rollerContext = new MockRollerContext();
            rollerContext.init(ctx);

            // setup mock request
            mockRequest = mockFactory.getMockRequest();
            mockRequest.setContextPath("/roller");

            // create MockRunner test module
            servletTestModule = new ServletTestModule(mockFactory);
            servletTestModule.createServlet(AtomServlet.class);


            // create test data

            testUser = TestUtils.setupUser("entryTestUser");
            testWeblog = TestUtils.setupWeblog("entryTestWeblog", testUser);
            TestUtils.endSession(true);


            testWeblog = TestUtils.getManagedWebsite(testWeblog);

            createWeblogEntry(testWeblog, testUser,
                    "Test Entry #1", "Content for test entry #1");

            createWeblogEntry(testWeblog, testUser,
                    "Test Entry #2", "Content for test entry #2");

            createWeblogEntry(testWeblog, testUser,
                    "Test Entry #3", "Content for test entry #3");

            TestUtils.endSession(true);

            MediaFileManager fm = WebloggerFactory.getWeblogger().getMediaFileManager();
            MediaFileDirectory root = fm.getMediaFileRootDirectory(testWeblog);

            root.getId();

            testWeblog = TestUtils.getManagedWebsite(testWeblog);

            createMediaFile(testWeblog, "p47-thunderbolt.jpg",
                "P47 Thunderbolt", "image/png", root,
                getClass().getResourceAsStream("/uploadsdir/testblog2/p47-thunderbolt.jpg"));

            createMediaFile(testWeblog, "amsterdam.jpg",
                "View of Amsterdam", "image/jpeg", root,
                getClass().getResourceAsStream("/uploadsdir/testblog2/amsterdam.jpg"));

            TestUtils.endSession(true);

        } catch (Exception ex) {
            log.error(ex);
            throw new Exception("Test setup failed", ex);
        }
    }


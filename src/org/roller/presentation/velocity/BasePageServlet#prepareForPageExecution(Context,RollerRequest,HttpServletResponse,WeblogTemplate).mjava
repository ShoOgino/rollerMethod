    /**      * Prepare for page execution be setting content type, populating context,     * and processing the page decorator if needed.     */    protected Template prepareForPageExecution(Context ctx, RollerRequest rreq,         HttpServletResponse response, WeblogTemplate pd) throws Exception    {                            Template outty = null;        UserManager userMgr = rreq.getRoller().getUserManager();        WebsiteData wd = pd.getWebsite();                // if page has an extension - use that to set the contentType        String pageLink = pd.getLink();        String mimeType = getServletConfig().getServletContext().getMimeType(pageLink);        if(mimeType != null) {            // we found a match ... set the content type            response.setContentType(mimeType);        }                /* old way ... not as flexible -- Allen G        int period = pd.getLink().indexOf('.');        if (period > -1)         {            String extension = pd.getLink().substring(period+1);            if ("js".equals(extension))             {                extension = "javascript";            }            response.setContentType("text/" + extension);        }        */            // Made it this far, populate the Context        ContextLoader.setupContext( ctx, rreq, response );        // Get the page        outty =  getTemplate( pd.getId(), "UTF-8" );        /**         * User can define a Decorator Template.         */        if (wd != null)        {            // parse/merge Page template            StringWriter sw = new StringWriter();            outty.merge(ctx, sw);            ctx.put("decorator_body", sw.toString());            // replace outty with decorator Template            outty = findDecorator((String)ctx.get("decorator"), userMgr, wd);                        }        return outty;    }

    /**
     * Test lookup mechanisms.
     */
    public void testPermissionsLookups() throws Exception {
        
        log.info("BEGIN");
        
        try {
            // we need a second user for this test
            User user = TestUtils.setupUser("testPermissionsLookups");
            TestUtils.endSession(true);
            
            UserManager mgr = RollerFactory.getRoller().getUserManager();
            WeblogPermission perm = null;
            List perms = null;
            
            // get all permissions for a user
            perms = mgr.getAllPermissions(TestUtils.getManagedUser(user));
            assertEquals(0, perms.size());
            perms = mgr.getAllPermissions(TestUtils.getManagedUser(testUser));
            assertEquals(1, perms.size());
            
            // get all permissions for a weblog
            perms = mgr.getAllPermissions(TestUtils.getManagedWebsite(testWeblog));
            assertEquals(1, perms.size());
            
            perm = new WeblogPermission();
            perm.setUser(TestUtils.getManagedUser(user));
            perm.setWebsite(TestUtils.getManagedWebsite(testWeblog));
            perm.setPending(true);
            perm.setPermissionMask(WeblogPermission.AUTHOR);
            mgr.savePermissions(perm);
            TestUtils.endSession(true);
            
            // get pending permissions for a user
            perms = mgr.getPendingPermissions(TestUtils.getManagedUser(testUser));
            assertEquals(0, perms.size());
            perms = mgr.getPendingPermissions(TestUtils.getManagedUser(user));
            assertEquals(1, perms.size());
            
            // get pending permissions for a weblog
            perms = mgr.getPendingPermissions(TestUtils.getManagedWebsite(testWeblog));
            assertEquals(1, perms.size());
            
            // get permissions by id
            String id = perm.getId();
            perm = null;
            perm = mgr.getPermissions(id);
            assertNotNull(perm);
            assertEquals(id, perm.getId());
            
            // get permissions for a specific user/weblog
            perm = null;
            perm = mgr.getPermissions(TestUtils.getManagedWebsite(testWeblog), TestUtils.getManagedUser(testUser));
            assertNotNull(perm);
            assertEquals(WeblogPermission.ADMIN, perm.getPermissionMask());
            perm = null;
            perm = mgr.getPermissions(TestUtils.getManagedWebsite(testWeblog), TestUtils.getManagedUser(user));
            assertNotNull(perm);
            assertEquals(WeblogPermission.AUTHOR, perm.getPermissionMask());
            assertEquals(true, perm.isPending());
            
            // cleanup
            TestUtils.teardownPermissions(perm.getId());
            TestUtils.teardownUser(user.getId());
            TestUtils.endSession(true);
        } catch(Throwable t) {
            log.error("Error running test", t);
            throw (Exception) t;
        }
        
        log.info("END");
    }

